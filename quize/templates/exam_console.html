<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Exam Console</title>
    <style>
        :root { --bg: #f4f6f8; --card: #ffffff; --text: #333; --primary: #3498db; }
        body.dark-mode { --bg: #1a1a1a; --card: #2d2d2d; --text: #ecf0f1; --primary: #5dade2; }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; transition: 0.3s; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; padding: 15px; }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 15px; overflow-y: auto; }
        .q-btn { width: 40px; height: 40px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; background: #ecf0f1; color: #333; transition: 0.2s; }
        .q-btn:hover { transform: scale(1.1); }
        .q-btn.active { border: 3px solid #f1c40f; }
        .q-btn.answered { background: #27ae60; color: white; }
        .q-btn.flagged { background: #f39c12; color: white; }
        .q-btn.skipped { background: #95a5a6; color: white; }

        /* Main */
        .main { flex: 1; padding: 30px; display: flex; flex-direction: column; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .tools { display: flex; gap: 10px; }
        .tool-btn { background: var(--card); border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; border-radius: 4px; color: var(--text); }
        
        .question-box { background: var(--card); padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex: 1; overflow-y: auto; font-size: 16px; }
        .option-label { display: block; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { border-color: var(--primary); background: rgba(52, 152, 219, 0.1); }
        .option-label input { margin-right: 15px; transform: scale(1.3); }

        .footer { margin-top: 20px; display: flex; justify-content: space-between; }
        button.action-btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-prev { background: #7f8c8d; }
        .btn-flag { background: #f39c12; }
        .btn-next { background: #27ae60; }
        .btn-submit { background: #c0392b; }

        #timer { font-size: 24px; font-weight: bold; color: var(--primary); background: var(--card); padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Blocker */
        #blocker { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    </style>
</head>
<body>

    <div id="blocker">
        <h1>‚ö†Ô∏è Exam Paused</h1>
        <p>Security Check: Please enter Fullscreen.</p>
        <button onclick="enterFullScreen()" style="padding:15px 30px; background:#3498db; color:white; border:none; border-radius:5px; font-size:18px; cursor:pointer;">Resume Exam</button>
    </div>

    <div class="sidebar">
        <h3 style="margin-top:0;">Question Palette</h3>
        <div style="font-size:12px; display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
            <span style="color:#27ae60">‚ñ† Answered</span> 
            <span style="color:#f39c12">‚ñ† Review</span> 
            <span style="color:#ecf0f1">‚ñ† Pending</span>
        </div>
        <div id="palette" class="palette-grid"></div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div class="tools">
                <button class="tool-btn" onclick="toggleTheme()">üåô Theme</button>
                <button class="tool-btn" onclick="resizeFont(1)">A+</button>
                <button class="tool-btn" onclick="resizeFont(-1)">A-</button>
            </div>
            <div id="timer">00:00</div>
        </div>

        <div class="question-box" id="q-box">
            <h2 id="q-text">Loading...</h2>
            <div id="options-container"></div>
            <div id="coding-container" style="display:none;">
                <textarea id="code-editor" style="width:100%; height:200px; background:#222; color:#0f0; font-family:monospace; padding:10px;"></textarea>
                <button onclick="runCode()" style="background:#3498db; color:white; padding:10px; border:none; margin-top:10px;">‚ñ∂ Run Code</button>
                <pre id="code-output" style="background:#eee; padding:10px; margin-top:10px; color:#333;"></pre>
            </div>
        </div>

        <div class="footer">
            <div>
                <button class="action-btn btn-prev" onclick="nav(-1)">Previous</button>
                <button class="action-btn btn-flag" onclick="toggleFlag()">üö© Mark for Review</button>
            </div>
            <div>
                <button class="action-btn btn-next" onclick="nav(1)">Save & Next</button>
                <button class="action-btn btn-submit" onclick="submitExam()">Submit Exam</button>
            </div>
        </div>
    </div>

    <script>
        const questions = {{ questions | tojson }};
        const ATTEMPT_ID = {{ attempt_id }};
        const savedData = {{ saved_responses | tojson }}; // Load resume data
        let timeLeft = ({{ quiz_meta.duration_minutes }} || 30) * 60;
        let currentIdx = 0;
        let userResponses = {}; // Local state

        // Initialize Saved Data
        questions.forEach(q => {
            if (savedData[q.question_id]) {
                userResponses[q.question_id] = savedData[q.question_id];
            }
        });

        // --- UI TOOLS ---
        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        let fSize = 16;
        function resizeFont(n) { fSize += n; document.getElementById('q-box').style.fontSize = fSize + 'px'; }

        // --- NAVIGATION ---
        function loadQuestion(idx) {
            if (idx < 0 || idx >= questions.length) return;
            currentIdx = idx;
            const q = questions[idx];
            document.getElementById('q-text').innerText = `Q${idx+1}: ${q.question_text}`;
            
            // Highlight Palette
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${idx}`).classList.add('active');

            // Render Inputs
            const cont = document.getElementById('options-container');
            const codeCont = document.getElementById('coding-container');
            
            if (q.question_type === 'CODE') {
                cont.style.display = 'none';
                codeCont.style.display = 'block';
                window.currentTestCase = { input: q.test_input, output: q.test_output };
            } else {
                codeCont.style.display = 'none';
                cont.style.display = 'block';
                const opts = [{k:'A', v:q.option_a}, {k:'B', v:q.option_b}, {k:'C', v:q.option_c}, {k:'D', v:q.option_d}];
                
                // Get saved answer
                const savedAns = userResponses[q.question_id] ? userResponses[q.question_id].opt : null;

                let html = "";
                opts.forEach(o => {
                    let checked = (savedAns === o.k) ? 'checked' : '';
                    html += `<label class="option-label"><input type="radio" name="opt" value="${o.k}" ${checked}> ${o.v}</label>`;
                });
                cont.innerHTML = html;
            }
        }

        function nav(dir) {
            saveCurrent();
            loadQuestion(currentIdx + dir);
        }

        // --- LOGIC ---
        function saveCurrent() {
            const q = questions[currentIdx];
            let ans = null;
            if (q.question_type === 'MCQ') {
                const sel = document.querySelector('input[name="opt"]:checked');
                if (sel) ans = sel.value;
            }
            
            // Only save if answer exists or explicitly saving
            if (ans) {
                // Update Local
                if (!userResponses[q.question_id]) userResponses[q.question_id] = {};
                userResponses[q.question_id].opt = ans;
                
                // Update UI
                const btn = document.getElementById(`btn-${currentIdx}`);
                btn.classList.add('answered');
                
                // Send to Server
                fetch('/api/save_answer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attempt_id: ATTEMPT_ID, 
                        question_id: q.question_id, 
                        option: ans,
                        is_flagged: userResponses[q.question_id].flag ? 1 : 0
                    })
                });
            }
        }

        function toggleFlag() {
            const qId = questions[currentIdx].question_id;
            if (!userResponses[qId]) userResponses[qId] = {};
            
            userResponses[qId].flag = !userResponses[qId].flag;
            
            const btn = document.getElementById(`btn-${currentIdx}`);
            if (userResponses[qId].flag) btn.classList.add('flagged');
            else btn.classList.remove('flagged');

            // Save flag state
            saveCurrent();
        }

        function submitExam() {
            if (!confirm("Finish Exam?")) return;
            fetch('/api/submit_quiz', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ attempt_id: ATTEMPT_ID })
            }).then(() => window.location.href = "/student");
        }

        // --- INIT ---
        const pal = document.getElementById('palette');
        questions.forEach((q, i) => {
            let cls = 'q-btn';
            if (userResponses[q.question_id]) {
                if (userResponses[q.question_id].opt) cls += ' answered';
                if (userResponses[q.question_id].flag) cls += ' flagged';
            }
            pal.innerHTML += `<button id="btn-${i}" class="${cls}" onclick="navTo(${i})">${i+1}</button>`;
        });
        
        function navTo(i) { saveCurrent(); loadQuestion(i); }
        loadQuestion(0);

        // Timer
        setInterval(() => {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
            if (timeLeft <= 0) submitExam();
            timeLeft--;
        }, 1000);

        // Fullscreen
        function enterFullScreen() {
            document.documentElement.requestFullscreen().catch(console.log);
            document.getElementById('blocker').style.display = 'none';
        }
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === "ArrowRight") nav(1);
            if (e.key === "ArrowLeft") nav(-1);
        });

    </script>
</body>
</html>