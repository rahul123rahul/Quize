<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QCMS Admin Dashboard</title>

<style>
/* CSS Styles (Simplified for brevity, same as before) */
*{margin:0;padding:0;box-sizing:border-box}body{font-family:"Segoe UI",Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}.layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}.sidebar{background:#1f2d3a;color:#fff;padding:25px 20px;position:sticky;top:0;height:100vh}.sidebar a{display:block;padding:12px 15px;margin-bottom:8px;color:#ecf0f1;text-decoration:none;border-radius:6px}.sidebar a:hover{background:#3498db}.content{padding:35px;overflow-x:hidden}.card{background:#fff;border-radius:12px;padding:25px;margin-bottom:25px;box-shadow:0 8px 25px rgba(0,0,0,.15)}.card h3{margin-bottom:15px;border-bottom:3px solid #3498db;padding-bottom:8px}input,select,textarea{width:100%;padding:11px;border-radius:6px;border:2px solid #ddd;margin-bottom:10px}button{padding:11px;border:none;border-radius:6px;font-weight:600;cursor:pointer}.btn-blue{background:#3498db;color:#fff}.btn-green{background:#27ae60;color:#fff}table{width:100%;border-collapse:collapse;margin-top:15px}th{background:#2c3e50;color:#fff;padding:12px;text-align:left}td{padding:10px;border-bottom:1px solid #ecf0f1}
</style>
</head>
<body>
<div class="layout">
<div class="sidebar">
    <h2>QCMS Admin</h2>
    <a href="#announcement">Announcement</a>
    <a href="#upload">Upload Questions</a>
    <a href="#session">Create Session</a>
    <a href="#sessions">Manage Sessions</a>
    <a href="#manualq">Add Question</a>
    <a href="#questions">Question Bank</a>
    <a href="#results">Results & Certs</a>
    <a href="/logout" style="background:#c0392b; text-align:center;">Logout</a>
</div>
<div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:20px;">
        <div class="card" style="background:#3498db; color:white; text-align:center; padding:20px;">
            <h1 style="margin:0; font-size:40px;">{{ stats.students }}</h1>
            <p>Total Students</p>
        </div>
        <div class="card" style="background:#2ecc71; color:white; text-align:center; padding:20px;">
            <h1 style="margin:0; font-size:40px;">{{ stats.exams }}</h1>
            <p>Exams Taken</p>
        </div>
        <div class="card" style="background:#f39c12; color:white; text-align:center; padding:20px;">
            <h1 style="margin:0; font-size:40px;">{{ stats.avg }}%</h1>
            <p>Avg Score</p>
        </div>
    </div>

    <div style="text-align:right; margin-bottom:10px;">
        <a href="/admin/export_results" style="background:#2c3e50; color:white; padding:10px 20px; text-decoration:none; border-radius:5px; font-weight:bold;">
            üì• Export Results to CSV
        </a>
    </div>

<div class="content">

<div class="card" id="announcement" style="background:#d4edda; border-left:5px solid #27ae60;">
<h3>üèÜ Announcement</h3>
{% if winners %}
<form method="POST" action="/admin/announce_winner" style="display:flex; gap:10px;">
    <select name="winner_name">
        {% for w in winners %}
        <option value="{{ w.full_name }}">{{ w.full_name }} ({{ w.total_score }} pts)</option>
        {% endfor %}
    </select>
    <button class="btn-green">Announce</button>
</form>
<a href="/admin/clear_announcement" style="color:red; display:block; margin-top:5px;">Hide Announcement</a>
{% else %}<p>No results yet.</p>{% endif %}
</div>

<div class="card" id="upload">
<h3>Upload Questions (DOCX)</h3>
<form method="POST" action="/upload_docx" enctype="multipart/form-data">
    <select name="quiz_id" required>
        {% for q in quizzes %}
        <option value="{{ q.quiz_id }}">{{ q.title }}</option>
        {% endfor %}
    </select>
    <input type="file" name="file" accept=".docx" required>
    <button class="btn-blue">Upload</button>
</form>
</div>

<div class="card" id="session">
<h3>Create Exam Session</h3>
<form method="POST" action="/create_quiz_session">
    <input type="text" name="title" placeholder="Session Title" required>
    <div style="display:flex; gap:10px;">
        <select name="category"><option>General</option><option>Coding</option><option>Aptitude</option></select>
        <input type="datetime-local" name="start_time" required>
    </div>
    <div style="display:flex; gap:10px;">
        <input type="number" name="duration" placeholder="Duration (mins)" required>
        <input type="number" name="total_marks" placeholder="Total Marks" required>
    </div>
    <button class="btn-green">Create Session</button>
</form>
<select name="quiz_id" required>
    {% for q in quizzes %}
        <option value="{{ q.quiz_id }}">{{ q.title }}</option>
    {% else %}
        <option value="" disabled selected>‚ö†Ô∏è No Sessions Found - Create one first!</option>
    {% endfor %}
</select>
</div>

<div class="card" id="sessions">
    <h3>‚öôÔ∏è Manage Created Sessions</h3>
    <div style="max-height: 300px; overflow-y: auto;">
        {% for q in quizzes %}
        <form action="/session/edit/{{ q.quiz_id }}" method="POST" style="display:grid; grid-template-columns: 2fr 2fr 1fr 1fr; gap:10px; padding:10px; border-bottom:1px solid #eee; align-items:center;">
            <input type="text" name="title" value="{{ q.title }}" required>
            <input type="datetime-local" name="start_time" value="{{ q.start_time | replace(' ', 'T') }}" required>
            <input type="number" name="duration" value="{{ q.duration_minutes }}" style="width:60px;">
            <input type="hidden" name="category" value="{{ q.category }}">
            <input type="hidden" name="total_marks" value="{{ q.total_marks }}">
            <div>
                <button type="submit" style="background:#f39c12; color:white; border:none; padding:5px 10px; cursor:pointer;">üíæ</button>
                <a href="/session/delete/{{ q.quiz_id }}" onclick="return confirm('Delete?')" style="text-decoration:none;">üóëÔ∏è</a>
            </div>
        </form>
        {% endfor %}
    </div>
</div>

<div class="card" id="manualq">
<h3>Add Question Manually</h3>
<form method="POST" action="/admin/add_manual_question">
    <select name="quiz_id" required>
        {% for quiz in quizzes %}
        <option value="{{ quiz.quiz_id }}">{{ quiz.title }}</option>
        {% endfor %}
    </select>
    <select name="q_type" id="q_type" onchange="toggleFields()">
        <option value="MCQ">MCQ</option><option value="CODE">Coding</option>
    </select>
    <textarea name="q_text" placeholder="Question text" required></textarea>
    <div id="mcq_fields">
        <input name="opt_a" placeholder="Option A"><input name="opt_b" placeholder="Option B">
        <input name="opt_c" placeholder="Option C"><input name="opt_d" placeholder="Option D">
        <select name="correct_opt"><option>A</option><option>B</option><option>C</option><option>D</option></select>
    </div>
    <div id="code_fields" style="display:none">
        <textarea name="test_input" placeholder="Input"></textarea><textarea name="test_output" placeholder="Output"></textarea>
    </div>
    <button class="btn-green">Add Question</button>
</form>
</div>

<div class="card" id="results">
<h3>Student Results</h3>
<table>
<thead><tr><th>ID</th><th>Name</th><th>Quiz</th><th>Score</th><th>Status</th><th>Certificate</th></tr></thead>
<tbody>
{% for r in attempts %}
<tr>
<td>#{{ r.attempt_id }}</td>
<td>{{ r.full_name }}</td>
<td>{{ r.title }}</td>
<td>{{ r.total_score }}</td>
<td>{{ r.status }}</td>
<td style="text-align:center;">
    {% if r.status == 'Completed' %}
        {% if r.certificate_approved == 1 %}
            <span style="color:green;">‚úÖ Unlocked</span><br>
            <a href="/download/cert/{{ r.attempt_id }}" target="_blank" style="font-size:12px;">View PDF</a>
        {% else %}
            <span style="color:gray;">üîí Locked</span><br>
            <a href="/admin/approve_cert/{{ r.attempt_id }}" class="btn-green" style="font-size:11px; text-decoration:none; padding:2px 5px;">Unlock</a>
        {% endif %}
    {% else %} -- {% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<div class="card" id="questions">
    <h3>üìù Question Bank</h3>
    <select id="sessionFilter" onchange="filterQuestions()" style="margin-bottom:10px;">
        <option value="all">Show All</option>
        <option value="0">General</option>
        {% for z in quizzes %}<option value="{{ z.quiz_id }}">{{ z.title }}</option>{% endfor %}
    </select>
    <form id="bulkForm" action="/admin/delete_bulk_questions" method="POST">
        <div style="max-height: 400px; overflow-y: auto;">
            <table>
                <thead style="position:sticky; top:0;">
                    <tr><th><input type="checkbox" onclick="toggleAll(this)"></th><th>Question</th><th>Session</th><th>Action</th></tr>
                </thead>
                <tbody>
                    {% for q in questions %}
                    <tr class="q-row" data-session="{{ q.quiz_id_safe }}">
                        <td><input type="checkbox" name="q_ids" value="{{ q.question_id }}"></td>
                        <td>{{ q.question_text }}</td>
                        <td>{{ q.session_name }}</td>
                        <td><a href="/question/edit/{{ q.question_id }}">Edit</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button onclick="if(confirm('Delete?')) document.getElementById('bulkForm').submit()" style="margin-top:10px; background:red; color:white;">Delete Selected</button>
    </form>
</div>

</div></div>

<script>
function toggleFields(){
    let t=document.getElementById("q_type").value;
    document.getElementById("mcq_fields").style.display=t==="MCQ"?"block":"none";
    document.getElementById("code_fields").style.display=t==="CODE"?"block":"none";
}
function filterQuestions() {
    var sel = String(document.getElementById("sessionFilter").value);
    var rows = document.getElementsByClassName("q-row");
    for (var i=0; i<rows.length; i++) {
        var rowSession = String(rows[i].getAttribute("data-session"));
        rows[i].style.display = (sel === "all" || rowSession === sel) ? "" : "none";
    }
}
function toggleAll(src) {
    document.getElementsByName('q_ids').forEach(c => c.checked = src.checked);
}
</script>
</body>
</html>